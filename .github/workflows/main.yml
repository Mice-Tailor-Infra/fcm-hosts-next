name: FCM Hosts Pipeline

on:
  schedule:
    # æ¯ 6 å°æ—¶æ‰§è¡Œä¸€æ¬¡ (UTC 0, 6, 12, 18)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
      - 'requirements.txt'

env:
  PYTHON_VERSION: '3.11'

jobs:
  harvest:
    runs-on: ubuntu-latest
    name: Harvest IPs from Google DNS

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Harvester
        run: |
          python scripts/harvest.py

      - name: Upload raw IPs artifacts
        uses: actions/upload-artifact@v4
        with:
          name: raw-ips
          path: |
            raw_ips_v4.txt
            raw_ips_v6.txt
          retention-days: 1

  verify:
    needs: harvest
    runs-on: [self-hosted, AliYun-ECS]
    name: Verify and Select Premium IPs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download raw IPs artifacts
        uses: actions/download-artifact@v4
        with:
          name: raw-ips
          path: .

      - name: Display downloaded files
        run: |
          echo "=== Downloaded files ==="
          ls -la raw_*.txt 2>/dev/null || echo "No raw IP files found"

      - name: Run Sommelier
        run: |
          python scripts/sommelier.py

      - name: Display generated hosts files
        run: |
          echo "=== Generated hosts files ==="
          ls -la fcm_*.hosts 2>/dev/null || echo "No hosts files found"

      - name: Upload hosts artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fcm-hosts
          path: |
            fcm_ipv4.hosts
            fcm_dual.hosts
            fcm_ipv6.hosts
          retention-days: 1

  publish:
    needs: verify
    runs-on: ubuntu-latest
    name: Publish to Repository

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Download hosts artifacts
        uses: actions/download-artifact@v4
        with:
          name: fcm-hosts
          path: .

      - name: Display hosts files
        run: |
          echo "=== Hosts files to publish ==="
          ls -la fcm_*.hosts

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and Push
        run: |
          # æ·»åŠ  hosts æ–‡ä»¶
          git add fcm_ipv4.hosts fcm_dual.hosts fcm_ipv6.hosts 2>/dev/null || true

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # æäº¤
          git commit -m "$(cat <<EOF
          Update FCM hosts - $(date -u +'%Y-%m-%d %H:%M UTC')

          Auto-generated by GitHub Actions

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"

          # æ¨é€
          git push origin main
